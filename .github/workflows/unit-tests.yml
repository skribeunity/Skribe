name: .NET Framework 4.8 CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.1.1

      - name: Restore NuGet packages
        run: nuget restore Skribe.sln

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          # Required to run dotnet test on .NET Framework projects
          dotnet-version: '7.0.x'

      - name: Build
        run: dotnet build --no-restore

      - name: Install NUnit Console Runner
        run: nuget install NUnit.ConsoleRunner -Version 3.20.0 -OutputDirectory testrunner
        
      - name: Find UnitTests.dll directory
        id: find_test_dll
        shell: pwsh
        run: |
          $dll = Get-ChildItem -Path . -Recurse -Filter UnitTests.dll | Select-Object -First 1
          if (-not $dll) {
            Write-Error "UnitTests.dll not found"
            exit 1
          }
          $folder = Split-Path $dll.FullName
          "TEST_DLL_FOLDER=$folder" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      - name: Run NUnit tests
        run: |
          testrunner\NUnit.ConsoleRunner.3.20.0\tools\nunit3-console.exe "$env:TEST_DLL_FOLDER\UnitTests.dll"
        shell: pwsh
